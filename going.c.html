<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>going.c</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
  <style> 
    th.code, 
    td.code { 
      background-color: #eee; 
      border-left: 1px solid #dbdbdb; 
    } 
  </style>
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>going.c</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-Design'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Design">&#182;</a>
        </div>
        <p>Ensure your processes are still <code>going</code>. A simple ICS licensed
process supervisor.</p>

<h2>Design</h2>

<p><code>going</code> is designed to spawn child processes and respawn them if they
terminate. Through the magic of POSIX a parent process will be
delivered a <code>SIGCHLD</code> signal when a child process terminates.
<code>going</code> will therefore sleep until it&#39;s notified to wake up so that
it can attend to terminated child processes. Frequent polling of the
status of a process commonly seen in process monitors is therefore neither
needed nor desirable.</p>

<p>If a child terminates too fast (within a window of 5 seconds) it will be
quarantined for 30 seconds before it will be respawned.</p>

<p>All abnormal events will be logged to the daemon facility of the
system log (typically found in <code>/var/log/daemon.log</code>).</p>

<p><code>going</code> is designed to be run from the <code>inittab(5)</code> so that <code>init(8)</code>
can respawn it in the unlikely event that it will terminate.</p>

<h2>Usage</h2>

<p>See <a href="going.8.html"><code>going(8)</code></a> and <a href="going.5.html"><code>going(5)</code></a>.</p>

<h2>Portability</h2>

<p><code>going</code> is written in C99 specially for GNU/Linux systems. No special care
has been taken to make this program protable to other UNIX plattforms.
While no Linux-only system calls is currently in use future versions of
<code>going</code> will likely take advantage of <code>epoll(7)</code>, <code>inotify(7)</code>, and
<code>signalfd(2)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Dependencies'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Dependencies">&#182;</a>
        </div>
        <h2>Dependencies</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Include memory allocation and process control functions and macros like
<code>exit(3)</code>, <code>atexit(3)</code>, <code>calloc(3)</code>, and <code>EXIT_SUCCESS</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;stdlib.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Include POSIX operating system functions like
<code>fork(3)</code>, <code>setsid(3)</code>, <code>execvp(3)</code>, and <code>sleep(3)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;unistd.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Include macros giving us access to the boolean types <code>true</code> and <code>false</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;stdbool.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Include string operation functions like
<code>strncmp(3)</code>, <code>strsep(3)</code>, <code>strcpy(3)</code>, and <code>strnlen(3)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;string.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Include core buffered input and output functions and macros like
<code>fprintf(3)</code>, <code>snprintf(3)</code>, <code>fopen(3)</code>, <code>fclose(3)</code>, and <code>FILE</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;stdio.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Include functions and structures for working with directory entries like
<code>scandir(3)</code> and <code>struct dirent</code>. </p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;dirent.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Include date and time handling functions like <code>time(3)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;time.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Include declaration of the global <code>errno</code> and matching symbolic constants
like <code>EAGAIN</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;errno.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Include pre-defined values to be used with <code>exit(3)</code> like
<code>EX_USAGE</code> and <code>EX_OSFILE</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;sysexits.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Include macros for handling variable arguments like 
<code>va_start(3)</code>, <code>va_end(3)</code> and <code>va_list</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;stdarg.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Include functions and constants for logging to the system log like
<code>openlog(3)</code>, <code>closelog(3)</code>, <code>vsyslog(3)</code>, <code>LOG_DAEMON</code>, <code>LOG_PID</code>,
<code>LOG_EMERG</code>, and <code>LOG_WARNING</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;sys/syslog.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Include functions and symbolic constants for waiting for children like
<code>waitpid(3)</code>, and <code>WNOHANG</code>.
This header implicitly includes <code>signal.h</code> which gives us signal
handling functions, constants, and types like <code>kill(3)</code>, <code>sigemptyset(3)</code>,
<code>sigprocmask(3)</code>, <code>sigaddset(3)</code>, <code>SIGCHLD</code>, <code>SIGHUP</code> and <code>sigset_t</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &lt;sys/wait.h&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Include constants, type definitions, and function prototypes from
the <a href="going.h.html"><code>going.h</code> header file</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cp">#include &quot;going.h&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>We need a global pointer to the head of the linked list of children we&#39;re
going to supervise. See <a href="going.h.html"><code>going.h</code></a> for the definition of
the <code>child_t</code> type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">static</span> <span class="n">child_t</span> <span class="o">*</span><span class="n">head_ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Entrypoint'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Entrypoint">&#182;</a>
        </div>
        <h2>Entrypoint</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sigset_t</span> <span class="n">block_mask</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>First we parse the command line arguments to check for a non-standard
configuration directory. If no such argument was given we get the
default <code>/etc/going.d</code>. If an invalid command line flag was given
the parse function will exit this process abnormally.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">confdir</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>We setup our cleanup function as an exit handler which will be
called at normal process termination.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">atexit</span><span class="p">(</span><span class="n">cleanup_children</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>The signals we&#39;re going to handle in our main loop is blocked.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">block_signals</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_mask</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>We parse configuration files in the configuration directory
into our global linked list of child structures.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">parse_confdir</span><span class="p">(</span><span class="n">confdir</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>All quarantined (a newly initialized child structure is quarantined by
default) children is spawned for the first time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">spawn_unquarantined_children</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>We launch our main loop which waits for signals and handles them
until it receives a terminating signal and promptly exits this process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">wait_forever</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_mask</span><span class="p">,</span> <span class="n">confdir</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>This return will never be reached, but it can&#39;t hurt.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Argument_parsing'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Argument_parsing">&#182;</a>
        </div>
        <h2>Argument parsing</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Returns the default configuration directory or a non-standard location
if the configuration directory command line flag is found.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">parse_args</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>If we only have on argument, the name of the binary for this source,
we simply return the default configuration directory.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">CONFIG_DIR</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>If we have two extra arguments, the first matching our  configuration
directory flag and the second beeing non-empty, we return the second
value as the configuration directory.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">CMD_FLAG_CONFDIR</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="o">&amp;&amp;</span> <span class="n">str_not_empty</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>The user has given and illegal number or type of arguments. The program
usage is printed to the standard error stream and we exit abnormally.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">USAGE</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="n">EX_USAGE</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Configuration'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Configuration">&#182;</a>
        </div>
        <h2>Configuration</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Parse_configuration_directory'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Parse_configuration_directory">&#182;</a>
        </div>
        <h3>Parse configuration directory</h3>

<p>Reads configuration files from the directory given and adds/removes
elements to a linked list of children accordingly.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">parse_confdir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">dirent</span> <span class="o">**</span><span class="n">dlist</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>We use <code>scandir(3)</code> since it gives us a nice sorted list of the
files in a directory compared to <code>opendir(3)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kt">int</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">scandir</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dlist</span><span class="p">,</span> <span class="n">only_files_selector</span><span class="p">,</span> <span class="n">alphasort</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>If the configuration directory is unavailable we&#39;re in serious trouble
and simply exit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ALERT</span><span class="p">,</span> <span class="s">&quot;Can&#39;t open %s: %m&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EX_OSFILE</span><span class="p">);</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Add children for the configuration files in the directory listing to the
global linked list if they are not present.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">add_new_children</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dlist</span><span class="p">,</span> <span class="n">dn</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Remove children from the global linked list and terminate them if they
do not have a configuration file in the directory listing anymore.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">remove_old_children</span><span class="p">(</span><span class="n">dlist</span><span class="p">,</span> <span class="n">dn</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>We have to free the heap allocated memory for the directory list
initialized by <code>scandir(3)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">(</span><span class="n">dn</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="n">dn</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">dlist</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Add_unseen_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Add_unseen_children">&#182;</a>
        </div>
        <h3>Add unseen children</h3>

<p>Iterates over its given list of configuration files and adds any unseen
children to our global linked list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">add_new_children</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dirent</span> <span class="o">**</span><span class="n">dlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dn</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">child_t</span> <span class="o">*</span><span class="n">tail_ch</span> <span class="o">=</span> <span class="n">get_tail_child</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">PATH_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>We only check this configuration file if we don&#39;t have a child
with the same name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_child</span><span class="p">(</span><span class="n">dlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>Create a full path to this configuration file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">PATH_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>Try to open the configuration file for reading. If we&#39;re unable to
open it we skip this configuration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">((</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>Allocate memory to hold a child structure for this configuration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">safe_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">child_t</span><span class="p">));</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>Try to parse this configuration file into the child structure we
recently allocated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">parse_config</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">dlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>If we successfully parsed this configuration file we have to add
the resulting child structure to our linked list of children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="p">(</span><span class="n">tail_ch</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>If we have a non-null tail child we add this child after it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">tail_ch</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>If we don&#39;t have a tail child, this child is shall be the
head of the global linked list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">head_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
          <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>This child is now the new tail of the global linked list of
children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">tail_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>If we were unable to parse the configuration we free the
allocated memory for the child strucure since we don&#39;t longer
need it and have no references to it after this function exits.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">cleanup_child</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>Flush the stream and close the underlying file descriptor for the
opened configuration file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>If we were unable to open the configuration file for reading we
skip this configuration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ERR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t read %s: %m&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Remove_obselete_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Remove_obselete_children">&#182;</a>
        </div>
        <h3>Remove obselete children</h3>

<p>Iterates over the global linked list of children and checks that
each is still present in the given list of configuration files. Those
without a corresponding configuration file is removed form the linked
list and the child process is terminated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">remove_old_children</span><span class="p">(</span><span class="k">struct</span> <span class="n">dirent</span> <span class="o">**</span><span class="n">dlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dn</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">child_t</span> <span class="o">*</span><span class="n">prev_ch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-51'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-51">&#182;</a>
        </div>
        <p>Iterate over all children, point <code>prev_ch</code> to the active child
right before the next iteration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">for</span> <span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="p">;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">prev_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-52'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-52">&#182;</a>
        </div>
        <p>Check if we have a configuration file for this child identified
by its name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child_active</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dlist</span><span class="p">,</span> <span class="n">dn</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-53'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-53">&#182;</a>
        </div>
        <p>If we have no configuration file for this child we have to
remove it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">prev_ch</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-54'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-54">&#182;</a>
        </div>
        <p>If we have a child before this child in the global linked list
we point that to the child after this one. If this is the
last child the child before this will be the new last child.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">prev_ch</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-55'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-55">&#182;</a>
        </div>
        <p>If this child is the first in the global linked list we point
our global head pointer to the child after this one. If this is
the first and last child, the head pointer will be null.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">head_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-56'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-56">&#182;</a>
        </div>
        <p>We terminate the child process when it no longer has a
configuration file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">kill_child</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-57'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-57">&#182;</a>
        </div>
        <p>After terminating the child process we make sure to free the
memory its scructure took up on the heap.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">cleanup_child</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Parse_a_configuration_file'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Parse_a_configuration_file">&#182;</a>
        </div>
        <h3>Parse a configuration file</h3>

<p>Parses the given configuration file into the given child structure.
Returns true if the format of the configuration file was valid and
false otherwise.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">bool</span> <span class="nf">parse_config</span><span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">CONFIG_LINE_BUFFER_SIZE</span><span class="p">],</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-59'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-59">&#182;</a>
        </div>
        <p>Set the default working directory to the root of the filesystem.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">strcpy</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">);</span>
  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-60'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-60">&#182;</a>
        </div>
        <p>We set the child as quarantined so that we can use the
<code>spawn_unquarantined_children()</code> function to bring it up.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">quarantined</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-61'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-61">&#182;</a>
        </div>
        <p>Since the name member of our child structure has a constant size we have
to ensure that the name given from the configuration&#39;s filename fits.
If the name was too large we return immediately with an invalid status.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">safe_strcpy</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ERR</span><span class="p">,</span> <span class="s">&quot;Configuration file name %s is too long (max: %d)&quot;</span><span class="p">,</span>
         <span class="n">name</span><span class="p">,</span> <span class="n">CHILD_NAME_SIZE</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-62'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-62">&#182;</a>
        </div>
        <p>We iterate over the lines in the configuration file until we reach EOF.
For safety we use <code>fgets(3)</code> which reads at most one less than the given
size of characters into the buffer and terminates it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-63'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-63">&#182;</a>
        </div>
        <p>A configuration key is found by searching the line until we find
a <code>=</code> character. <code>strsep(3)</code> returns a pointer equal to the given
line pointer and overwrites the <code>=</code> character by a terminating <code>\0</code>
character. <code>strsep(3)</code> then updates the given line pointer to point
past the token. In a successive call to <code>strsep(3)</code> to retrieve the
configuration value we search from the new location of the line pointer
until end of line.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">key</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-64'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-64">&#182;</a>
        </div>
        <p>If <code>strsep(3)</code> did not find the tokens we searched for the returned
pointers will be null.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-65'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-65">&#182;</a>
        </div>
        <p>We check if the configuration key matches the command key and
the value contains at least one character.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">CONFIG_CMD_KEY</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">str_not_empty</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-66'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-66">&#182;</a>
        </div>
        <p>If we&#39;re unable to copy the command value read from the
configuration file into the constant sized <code>cmd</code> member of our
child structure we return immediately with an invalid status.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">safe_strcpy</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)))</span> <span class="p">{</span>
          <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ERR</span><span class="p">,</span> <span class="s">&quot;Value of %s= in %s is too long (max: %d)&quot;</span><span class="p">,</span>
               <span class="n">CONFIG_CMD_KEY</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-67'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-67">&#182;</a>
        </div>
        <p>If this was not a command key, we check if the configuration key
matches the current working directory key and the value contains
at least one character.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">CONFIG_CWD_KEY</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">str_not_empty</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-68'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-68">&#182;</a>
        </div>
        <p>We try to copy the working directory value info the constant
sized <code>cwd</code> member of our child structure. We return
immediately with an invalid status if it did not fit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">safe_strcpy</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">)))</span> <span class="p">{</span>
          <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ERR</span><span class="p">,</span> <span class="s">&quot;Value of %s= in %s is too long (max: %d)&quot;</span><span class="p">,</span>
               <span class="n">CONFIG_CWD_KEY</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-69'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-69">&#182;</a>
        </div>
        <p>If we were able to populate our child structure with a command
we deem this configuration valid.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">return</span> <span class="n">str_not_empty</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Execution_of_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Execution_of_children">&#182;</a>
        </div>
        <h2>Execution of children</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Spawn_unquarantined_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Spawn_unquarantined_children">&#182;</a>
        </div>
        <h3>Spawn unquarantined children</h3>

<p>Iterates over all our children and spawn them if they currently are
quarantined and safely can be unquarantined.
This function can also spawn children for the first time since all
child structures are initialized as quarantined with a last started
timestamp of epoch.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">spawn_unquarantined_children</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-72'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-72">&#182;</a>
        </div>
        <p>Iterate over all children and spawn those which is quarantined
and can be unquarantined.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="p">;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-73'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-73">&#182;</a>
        </div>
        <p>The child can can be unquarantined if it:</p>

<ul>
<li>has never been spawned,</li>
<li>or was last spawned more than or equal to the value of
<code>QUARANTINE_PERIOD</code> ago.</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">quarantined</span>
        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">child_recently_spawned</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">QUARANTINE_PERIOD</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">spawn_child</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Respawn_terminated_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Respawn_terminated_children">&#182;</a>
        </div>
        <h3>Respawn terminated children</h3>

<p>Respawns all terminated children. This function is called
when we get a <code>SIGCHLD</code> signal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">bool</span> <span class="nf">respawn_terminated_children</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
  <span class="n">pid_t</span> <span class="n">ch_pid</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">all_respawned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-75'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-75">&#182;</a>
        </div>
        <p>We retrieve information about terminated child processes
using <code>waitpid(3)</code>. It&#39;s possible that we only get one <code>SIGCHLD</code>
signal delivered from the kernel even though more than one child
terminated. We therefore loop until we&#39;ve gotten the process id of
all terminated children. We use the <code>WNOHANG</code> flag so that we don&#39;t
block the thread until status of any terminated children is available.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">((</span><span class="n">ch_pid</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-76'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-76">&#182;</a>
        </div>
        <p>We iterate over our global linked list of children to find
the child structure of the exited child process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="p">;</span> <span class="n">ch</span><span class="p">;</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ch_pid</span> <span class="o">==</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-77'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-77">&#182;</a>
        </div>
        <p>If the child lived shorter than the value of <code>QUARANTINE_TRIGGER</code>
we mark the child as quarantined and log its misbehavior. The
child is not respawned.
In addition the return value for this function is set to be falsy
so that the caller can know that one or more children was
quarantined and not respawned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">child_recently_spawned</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">QUARANTINE_TRIGGER</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">slog</span><span class="p">(</span><span class="n">LOG_WARNING</span><span class="p">,</span> <span class="s">&quot;%s terminated after: %ds (limit: %ds) and &quot;</span> \
              <span class="s">&quot;will be quarantined for %ds&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span><span class="p">,</span>
              <span class="n">QUARANTINE_TRIGGER</span><span class="p">,</span> <span class="n">QUARANTINE_PERIOD</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
          <span class="n">ch</span><span class="o">-&gt;</span><span class="n">quarantined</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

          <span class="n">all_respawned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-78'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-78">&#182;</a>
        </div>
        <p>If the child lived longh enough to not be quarantined we log its
termination and respawn it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">slog</span><span class="p">(</span><span class="n">LOG_WARNING</span><span class="p">,</span> <span class="s">&quot;%s terminated after: %ds&quot;</span><span class="p">,</span>
               <span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span><span class="p">);</span>
          <span class="n">spawn_child</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">all_respawned</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Spawn_a_child'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Spawn_a_child">&#182;</a>
        </div>
        <h3>Spawn a child</h3>

<p>Spawns the command line of the given child by forking and execing
a child process of the parent <code>going</code> process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">spawn_child</span><span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-80'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-80">&#182;</a>
        </div>
        <p>The child is no longer quarantined since it obviously got the go-ahead
to spawn.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">ch</span><span class="o">-&gt;</span><span class="n">quarantined</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">pid_t</span> <span class="n">ch_pid</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-81'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-81">&#182;</a>
        </div>
        <p>We iterate until we get the desired behavior from <code>fork(3)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-82'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-82">&#182;</a>
        </div>
        <p><code>fork(3)</code> creates a new process which is an exact copy of its invoking
process. We are inside the child process if the return value is zero.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">((</span><span class="n">ch_pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-83'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-83">&#182;</a>
        </div>
        <p>FIXME: is this needed? do some research.
The child should have its own session and become the process
group leader.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">setsid</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-84'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-84">&#182;</a>
        </div>
        <p>We initialize an empty signal mask and block based on it, resulting
in blockage of no signals. This is done since the parent process
blocks certain signals and the child created by a <code>fork(3)</code> inherits
its parents block mask.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">sigset_t</span> <span class="n">empty_mask</span><span class="p">;</span>
      <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty_mask</span><span class="p">);</span>
      <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">empty_mask</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-85'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-85">&#182;</a>
        </div>
        <p>TODO: Should file descriptors 0, 1, 2 be closed or duped?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-86'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-86">&#182;</a>
        </div>
        <p>TODO: Close file descriptors which should not be inherited or
      use O_CLOEXEC when opening such files.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-87'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-87">&#182;</a>
        </div>
        <p>Change the current working directory to that specified in the
child&#39;s configuration file or the default <code>/</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">chdir</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ERR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t change working directory to %s: %m&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">);</span>
        <span class="n">cleanup_children</span><span class="p">();</span>
        <span class="n">_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
      <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-88'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-88">&#182;</a>
        </div>
        <p>Replace the child process with the executable reciding at the path
of the command line.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">exec_child</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-89'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-89">&#182;</a>
        </div>
        <p>If we reach this code the <code>execvp(3)</code> call failed. We log the error
and exit this child process. Note that the normal flow in the parent
continues, but it will get a <code>SIGCHLD</code> signal since one of its
children terminated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">slog</span><span class="p">(</span><span class="n">LOG_ERR</span><span class="p">,</span> <span class="s">&quot;Can&#39;t execute %s: %m&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
      <span class="n">cleanup_children</span><span class="p">();</span>
      <span class="n">_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-90'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-90">&#182;</a>
        </div>
        <p>If the return value of <code>fork(3)</code> is greater than zero we&#39;re in the
parent process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-91'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-91">&#182;</a>
        </div>
        <p>We note the time that the child process started so that we can track
its uptime.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-92'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-92">&#182;</a>
        </div>
        <p>Storing the process id of the child process is important so that we
know which process failed if we get a <code>SIGCHLD</code> signal later.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">ch</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">ch_pid</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-93'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-93">&#182;</a>
        </div>
        <p>If the return value of <code>fork(3)</code> is negative the call did not succeed.
We log the error and wait a little before trying again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">slog</span><span class="p">(</span><span class="n">LOG_EMERG</span><span class="p">,</span> <span class="s">&quot;Could not fork, sleeping %ds&quot;</span><span class="p">,</span> <span class="n">EMERG_SLEEP</span><span class="p">);</span>
      <span class="n">sleep</span><span class="p">(</span><span class="n">EMERG_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Exec_wrapper'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Exec_wrapper">&#182;</a>
        </div>
        <h3>Exec wrapper</h3>

<p>Parses the path and arguments from the given command line. Replaces
the current process with that of the executable file reciding at
the parsed path.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">exec_child</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-95'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-95">&#182;</a>
        </div>
        <p>A copy of the command line is made so that we can use <code>strsep(3)</code>
(which modifies its argument) against it. It is safe to use <code>strcpy(3)</code>
to copy the command line from our child structure into the buffer since
we know that their constant sizes are equal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kt">char</span> <span class="n">cmd_buf</span><span class="p">[</span><span class="n">CHILD_CMD_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">cmd_p</span> <span class="o">=</span> <span class="n">strcpy</span><span class="p">(</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-96'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-96">&#182;</a>
        </div>
        <p>To avoid allocating space on the heap for the argument vector we
use a constant sized array of pointers into the constant sized
<code>cmd_buf</code> buffer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="n">CHILD_ARGV_LEN</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">cmd_word</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-97'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-97">&#182;</a>
        </div>
        <p>We iterate until the pointer returned by <code>strsep(3)</code> into our command
line buffer is null, meaning no new words sperated by a space was found.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">((</span><span class="n">cmd_word</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_p</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-98'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-98">&#182;</a>
        </div>
        <p>If the word returned is the null byte we&#39;re dealing with repeating
spaces, so we skip it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd_word</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-99'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-99">&#182;</a>
        </div>
        <p>If we&#39;re in our first iteration we setup the two first slots
of the argument vector which explains why we initialized the index
to one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-100'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-100">&#182;</a>
        </div>
        <p>The first and second argument will be the path to the binary
we&#39;ll spawn.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_word</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-101'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-101">&#182;</a>
        </div>
        <p>The following arguments will be arguments given to the binary
we&#39;ll spawn.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_word</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-102'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-102">&#182;</a>
        </div>
        <p>The argument vector given to <code>execvp(3)</code> needs to be null terminated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-103'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-103">&#182;</a>
        </div>
        <p><code>execvp(3)</code> is used to replace this child process with the binary
reciding at the path we give as the first argument. In addition it
tries to look up the binary in <code>$PATH</code> if a non-absolute path is
given. By incrementing the <code>argv</code> pointer we give as the second
argument the receiver sees it as <code>argv[1:]</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">execvp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">argv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Signal_handling'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Signal_handling">&#182;</a>
        </div>
        <h2>Signal handling</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Block_handled_signals'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Block_handled_signals">&#182;</a>
        </div>
        <h3>Block handled signals</h3>

<p>For handling signals synchronously in our main loop with <code>sigtimedwait(3)</code>
we need to set the <code>going</code> process&#39; signal mask (a set of signals whose
delivery from the kernel is blocked).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">block_signals</span><span class="p">(</span><span class="n">sigset_t</span> <span class="o">*</span><span class="n">block_mask</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sigemptyset</span><span class="p">(</span><span class="n">block_mask</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-106'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-106">&#182;</a>
        </div>
        <p>The <code>SIGCHLD</code> signal is delivered if a child process terminates. The
entire <code>going</code> program is designed arround handling this signal and
respawning the terminated child process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigaddset</span><span class="p">(</span><span class="n">block_mask</span><span class="p">,</span> <span class="n">SIGCHLD</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-107'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-107">&#182;</a>
        </div>
        <p>The <code>SIGTERM</code> signal is the standard signal for terminating a process
and the default signal sent by <code>kill(1)</code>. We block it so that we can
handle it by cleaning up our main and child processes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigaddset</span><span class="p">(</span><span class="n">block_mask</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-108'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-108">&#182;</a>
        </div>
        <p>The <code>SIGINT</code> signal is sent when the user sends an terminal interrupt
(Ctrl-C). While <code>going</code> is not designed to be run from a controlling
terminal it&#39;s useful to handle this signal when testing/debugging.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigaddset</span><span class="p">(</span><span class="n">block_mask</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-109'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-109">&#182;</a>
        </div>
        <p>The <code>SIGHUP</code> signal can be used for reloading a daemon&#39;s configuration.
We block it so that we can do exactly that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigaddset</span><span class="p">(</span><span class="n">block_mask</span><span class="p">,</span> <span class="n">SIGHUP</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-110'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-110">&#182;</a>
        </div>
        <p>After building a signal set of those signals we&#39;re going to handle in
our main loop we set it as the signal process mask (blocked signals).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="n">block_mask</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Signal_handling_loop'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Signal_handling_loop">&#182;</a>
        </div>
        <h3>Signal handling loop</h3>

<p>Tha main loop of the <code>going</code> process waits for the kernel to deliver
signals we&#39;ve blocked with our process mask. Each signal is
accepted synchronously.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">wait_forever</span><span class="p">(</span><span class="n">sigset_t</span> <span class="o">*</span><span class="n">block_mask</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">confdir</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">timeout</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-112'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-112">&#182;</a>
        </div>
        <p>We loop until the process explicitly exits or the kernel decides
to terminate it. In each iteration we wait for a signal in our
process mask to arrive.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="k">switch</span><span class="p">(</span><span class="n">sigtimedwait</span><span class="p">(</span><span class="n">block_mask</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-113'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-113">&#182;</a>
        </div>
        <p>If no signal was delivered within the given timeout period we
get an <code>EAGAIN</code> error.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-114'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-114">&#182;</a>
        </div>
        <p>This means that we&#39;ve previously set a timeout of
<code>QUARANTINE_PERIOD</code> so that we could wake up and unquarantine
and spawn quarantined children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">spawn_unquarantined_children</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-115'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-115">&#182;</a>
        </div>
        <p>Since all quarantined children can be unquarantined and spawned
after waiting <code>QUARANTINE_PERIOD</code> we don&#39;t have to wake up
again before we get a new signal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">timeout</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-116'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-116">&#182;</a>
        </div>
        <p>When the <code>SIGCHLD</code> signal is delivered one (or possible several) of
our child processes has terminated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">case</span> <span class="n">SIGCHLD</span>:</pre></div>
      </td>
    </tr>
    <tr id='section-117'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-117">&#182;</a>
        </div>
        <p>In response to the termination of children we respawn them. The
<code>respawn_terminated_children()</code> function returns <code>false</code> if one
or more of the children which it tried to respawn was quarantined.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">respawn_terminated_children</span><span class="p">())</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-118'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-118">&#182;</a>
        </div>
        <p>If we&#39;ve quarantined one or more children we have to wake up
after <code>QUARANTINE_PERIOD</code> the next loop iteration and try to
spawn them then.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">timeout</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">QUARANTINE_PERIOD</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-119'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-119">&#182;</a>
        </div>
        <p>A <code>SIGHUP</code> signal indicates that we&#39;ve been requested to reload
our configuration of child processes to supervise.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">case</span> <span class="n">SIGHUP</span>:
      <span class="n">parse_confdir</span><span class="p">(</span><span class="n">confdir</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-120'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-120">&#182;</a>
        </div>
        <p>If we&#39;ve received new children to supervise those are spawned for
their first time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">spawn_unquarantined_children</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-121'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-121">&#182;</a>
        </div>
        <p>We&#39;ve received a terminating signal that we can handle. We should
clean up our main and child processes before exiting.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nl">default:</span>
      <span class="n">kill_children</span><span class="p">();</span>
      <span class="n">cleanup_children</span><span class="p">();</span>
      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Children_handling'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Children_handling">&#182;</a>
        </div>
        <h2>Children handling</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Tail_child'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Tail_child">&#182;</a>
        </div>
        <h3>Tail child</h3>

<p>Returns a pointer to the tail child of the global linked list
of children. Returns null if the head child is null.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">child_t</span> <span class="o">*</span><span class="nf">get_tail_child</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">child_t</span> <span class="o">*</span><span class="n">tail_ch</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">tail_ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="p">;</span> <span class="n">tail_ch</span><span class="p">;</span> <span class="n">tail_ch</span> <span class="o">=</span> <span class="n">tail_ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">tail_ch</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Existence_of_child'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Existence_of_child">&#182;</a>
        </div>
        <h3>Existence of child</h3>

<p>Check whether our liked list of children contains the given child
identified by name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="n">bool</span> <span class="nf">has_child</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="p">;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">CHILD_NAME_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Existence_of_config'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Existence_of_config">&#182;</a>
        </div>
        <h3>Existence of config</h3>

<p>Check whether a given child identified by name still is present in a
directory listing of our configuration directory.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="n">bool</span> <span class="nf">child_active</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dirent</span> <span class="o">**</span><span class="n">dlist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">CHILD_NAME_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Child_spawned_recently'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Child_spawned_recently">&#182;</a>
        </div>
        <h3>Child spawned recently</h3>

<p>Check whether a child was last spawned less than the given number
of seconds ago.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">bool</span> <span class="nf">child_recently_spawned</span><span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds_ago</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-127'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-127">&#182;</a>
        </div>
        <p>We have to check that:</p>

<ul>
<li>the child has been spawned before (indicated by a positive <code>up_at</code>
timestamp since its set to zero when a child is initialized),</li>
<li>and that the difference between the current time and the time
the child was spawned is less than the given number of seconds.</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">now</span> <span class="o">&gt;=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span> <span class="o">&amp;&amp;</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">up_at</span> <span class="o">&lt;</span> <span class="n">seconds_ago</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Kill_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Kill_children">&#182;</a>
        </div>
        <h3>Kill children</h3>

<p>Send all children a termination signal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">kill_children</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="p">;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">kill_child</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Terminate_child'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Terminate_child">&#182;</a>
        </div>
        <h3>Terminate child</h3>

<p>Terminate a given child by sending it the <code>SIGTERM</code> signal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">kill_child</span><span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">kill</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Remove_all_children'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Remove_all_children">&#182;</a>
        </div>
        <h3>Remove all children</h3>

<p>Free the memory consumed by our linked list of children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">cleanup_children</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">child_t</span> <span class="o">*</span><span class="n">tmp_ch</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-131'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-131">&#182;</a>
        </div>
        <p>Iterate until the head pointer of our linked list is null.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">(</span><span class="n">head_ch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-132'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-132">&#182;</a>
        </div>
        <p>Store a temporary pointer to the next child after the current head
of the linked list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">tmp_ch</span> <span class="o">=</span> <span class="n">head_ch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-133'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-133">&#182;</a>
        </div>
        <p>Free the memory the current head of the linked list points to.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">cleanup_child</span><span class="p">(</span><span class="n">head_ch</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-134'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-134">&#182;</a>
        </div>
        <p>Set the temporary pointer as the current head of the linked list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">head_ch</span> <span class="o">=</span> <span class="n">tmp_ch</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Free_memory_for_a_child'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Free_memory_for_a_child">&#182;</a>
        </div>
        <h3>Free memory for a child</h3>

<p>Free the memory consumed by the given child.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cleanup_child</span><span class="p">(</span><span class="n">child_t</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Utility_functions'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Utility_functions">&#182;</a>
        </div>
        <h2>Utility functions</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-String_content'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-String_content">&#182;</a>
        </div>
        <h3>String content</h3>

<p>A simple inline function to determine whether a string has any content.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="n">bool</span> <span class="nf">str_not_empty</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Safe_string_copy'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Safe_string_copy">&#182;</a>
        </div>
        <h3>Safe string copy</h3>

<p>A safe inline function for copying a string.
Returns true if the source string fits within the given size or false
if it was truncated according to the size argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kr">inline</span> <span class="n">bool</span> <span class="nf">safe_strcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-139'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-139">&#182;</a>
        </div>
        <p>We use <code>snprintf(3)</code> since <code>strcpy(3)</code> can overflow its desination string
and <code>strncpy(3)</code> does not ensure a terminating null for its destination.
If we had <code>strlcpy(3)</code> in GLIBC this function would be moot...</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Safe_heap_allocation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Safe_heap_allocation">&#182;</a>
        </div>
        <h3>Safe heap allocation</h3>

<p>A wrapper arround <code>calloc(3)</code> which blocks until we get a pointer to the
requested memory on the heap.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="o">*</span><span class="nf">safe_malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span>	<span class="o">*</span><span class="n">mp</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-141'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-141">&#182;</a>
        </div>
        <p>We retry until we get a non-null pointer to allocated memory.
<code>calloc(3)</code> is used in stead of <code>malloc(3)</code> so that the continous block
of memory we receive a pointer to is all zeroed out.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">while</span> <span class="p">((</span><span class="n">mp</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-142'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-142">&#182;</a>
        </div>
        <p>We were unable to allocate memory so we log the error and give the
system some time to get its act together.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">slog</span><span class="p">(</span><span class="n">LOG_EMERG</span><span class="p">,</span> <span class="s">&quot;Could not malloc, sleeping %ds&quot;</span><span class="p">,</span> <span class="n">EMERG_SLEEP</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">EMERG_SLEEP</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">mp</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Default_directory_file_selector'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Default_directory_file_selector">&#182;</a>
        </div>
        <h3>Default directory file selector</h3>

<p>A filter function used with <code>scandir(3)</code> which returns true for
all files in a directory excluding <code>.</code> and <code>..</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">int</span> <span class="nf">only_files_selector</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-System_logger'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-System_logger">&#182;</a>
        </div>
        <h3>System logger</h3>

<p>A <code>syslog(3)</code> convenience wrapper which takes a priority level, a
log message format, and a variable number of arguments to the message
format.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kt">void</span> <span class="nf">slog</span><span class="p">(</span><span class="kt">int</span> <span class="n">priority</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
  <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
  <span class="n">sigset_t</span> <span class="n">all_mask</span><span class="p">,</span> <span class="n">orig_mask</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-145'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-145">&#182;</a>
        </div>
        <p>We initialize a signal mask to contain all signals and block
them while we&#39;re logging to ensure a signal does not interrupt us. The
original signal mask is stored so we can reset it after logging.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigfillset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">all_mask</span><span class="p">);</span>
  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_mask</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-146'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-146">&#182;</a>
        </div>
        <p>We log to the daemon log, typically found in <code>/var/log/daemon.log</code> with
our ident and process id as prefixes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">openlog</span><span class="p">(</span><span class="n">IDENT</span><span class="p">,</span> <span class="n">LOG_PID</span><span class="p">,</span> <span class="n">LOG_DAEMON</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-147'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-147">&#182;</a>
        </div>
        <p>We use the <code>vsyslog(3)</code> function which takes a <code>va_list</code> in stead
of iterating over the list ourselves.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
  <span class="n">vsyslog</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
  <span class="n">closelog</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-148'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-148">&#182;</a>
        </div>
        <p>We reset our signal mask to the one in use before we blocked all signals.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_mask</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
